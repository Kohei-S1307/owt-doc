
# Introduction

This document provides the guide to setup end-to-end streaming out demo with owt-server.
- HTTP Live Streaming (HLS)
- Dynamic Adaptive Streaming over HTTP (DASH)

## System Requirements

- Ubuntu 18.04
- owt-server v4.3.x
- VLC media player (Recommended)
- Chrome (Version 81.0.4044.138 and later)

## OWT-SERVER

owt-server streaming out agent generates HLS or DASH stream containing H.264 video track and AAC audio track.<br/>
The owt-server package does not include H.264 and AAC third-party encoders by default.<br/>
Please install the dependencies to enable H.264 and AAC features.<br/>

- Install OpenH264 for H.264 video encoding

```bash
cd dist/video_agent
./install_openh264.sh
```

- Install FFmpeg with libfdk-aac for AAC audio encoding

```bash
cd dist/audio_agent
./compile_ffmpeg_with_libfdkaac.sh
cp ./ffmpeg_libfdkaac_lib/* ./lib/
```

## NGINX

A web server is required to host HLS or DASH fragments which are generated by owt-server. It can be or not be installed at the same machine with owt-server.<br/>
Nginx is used as the web server and installed at the same machine in this demo.<br/>
You are free to change Nginx to any other web server.

- Install Nginx

```bash
# install nginx
sudo apt install nginx-full

# disable other web servers if any
sudo systemctl stop apache2.service
sudo systemctl disable apache2.service

sudo systemctl stop lighttpd.service
sudo systemctl disable lighttpd.service

# enable nginx
sudo systemctl enable nginx.service
sudo systemctl start nginx.service

# check nginx status
sudo systemctl status nginx.service

# check the port if nginx start error
sudo netstat -tlpn
```

## HLS demo

### Create HLS demo web page

Open source JavaScript library hls.js is used for HTTP Live Streaming playback in browser for this demo.<br/>
https://github.com/video-dev/hls

- Create the hls demo web page in web server, as described in<br/>
https://github.com/video-dev/hls.js#getting-started

```bash
cd /var/www/html

# create hls folder and grant owt-server write access
sudo mkdir /var/www/html/hls
sudo chmod 777 /var/www/html/hls

cd /var/www/html/hls

# download hls.js
wget https://cdn.jsdelivr.net/npm/hls.js@latest -O hls.js

# create "hls-demo.html"
# load local "hls.js" and playback "test.m3u8" under "/var/www/html/hls"
vi ./hls-demo.html
```
```html
<script src="hls.js"></script>
<!-- Or if you want a more recent alpha version -->
<!-- <script src="https://cdn.jsdelivr.net/npm/hls.js@alpha"></script> -->
<video id="video" autoplay muted></video>
<script>
  var video = document.getElementById('video');
  var videoSrc = 'test.m3u8';
  if (Hls.isSupported()) {
    var hls = new Hls();
    hls.loadSource(videoSrc);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, function() {
      video.play();
    });
  }
  // hls.js is not supported on platforms that do not have Media Source
  // Extensions (MSE) enabled.
  //
  // When the browser has built-in HLS support (check using `canPlayType`),
  // we can provide an HLS manifest (i.e. .m3u8 URL) directly to the video
  // element through the `src` property. This is using the built-in support
  // of the plain video element, without using hls.js.
  //
  // Note: it would be more normal to wait on the 'canplay' event below however
  // on Safari (where you are most likely to find built-in HLS support) the
  // video.src URL must be on the user-driven white-list before a 'canplay'
  // event will be emitted; the last video event that can be reliably
  // listened-for when the URL is not on the white-list is 'loadedmetadata'.
  else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = videoSrc;
    video.addEventListener('loadedmetadata', function() {
      video.play();
    });
  }
</script>
```

### Start HSL stream out
- All HLS streaming out URLs **MUST** have the postfix **.m3u8**.
- Start owt-server streaming out with URL "/var/www/html/hls/test.m3u8".
- Check whether "test.m3u8" and multiple "test_xxxxx.ts" files are generated under "/var/www/html/hls/".

### Play HSL by VLC media player (Recommended)
- Open VLC, "Media" -> "Open Network Stream" -> "ht<span>tp://</span>SERVER-IP/hls/test.m3u8"

### Play HSL by Chrome browser
 - Open Chrome browser with URL "ht<span>tp://</span>SERVER-IP/hls/hls-demo.html".

## DASH demo

### Create DASH demo web page
Open source JavaScript library dash.js is used for DASH playback in browser for this demo.<br/>
https://github.com/Dash-Industry-Forum/dash.js

- Create the dash demo web page in web server, as described in<br/>
https://github.com/Dash-Industry-Forum/dash.js#standard-setup

```bash
cd /var/www/html/

# create dash folder and grant owt-server write access
sudo mkdir /var/www/html/dash
sudo chmod 777 /var/www/html/dash

cd /var/www/html/dash

# download dash.js
wget http://cdn.dashjs.org/latest/dash.all.debug.js

# create "dash-demo.html"
# load local "dash.all.debug.js" and playback "test.mpd" under "/var/www/html/dash"
vi ./dash-demo.html
```

```html
<!doctype html>
<html>
    <head>
        <title>Dash.js Rocks</title>
        <style>
            video {
                width: 640px;
                height: 360px;
            }
        </style>
    </head>
    <body>
        <div>
            <video id="videoPlayer" controls autoplay muted></video>
        </div>
        <script src="dash.all.debug.js"></script>
        <script>
            (function(){
                var url = "test.mpd";
                var player = dashjs.MediaPlayer().create();
                player.initialize(document.querySelector("#videoPlayer"), url, true);
            })();
        </script>
    </body>
</html>
```

### Start DASH stream out
- All DASH streaming out URLs **MUST** have the postfix **.mpd**.
- Start owt-server streaming out with URL "/var/www/html/dash/test.mpd".
- Check whether "test.mpd" and multiple " test-init-streamX.m4s", "test-chunk-streamX-XXXXX.m4s" files are generated under "/var/www/html/dash/".

### Play DASH by VLC media player (Recommended)
- Open VLC, "Media" -> "Open Network Stream" -> "ht<span>tp://</span>SERVER-IP/dash/test.mpd"

### Play DASH by Chrome browser
- Open Chrome browser with URL "ht<span>tp://</span>SERVER-IP/dash/dash-demo.html"